<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syst√®me de Commande Triathlon (HTML/JS)</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* Styles de base pour la structure */
        body { font-family: sans-serif; background-color: #f4f7f9; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .navbar { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; }
        .active { background-color: #3b82f6; color: white; }
        .inactive { background-color: white; color: #4b5563; border: 1px solid #d1d5db; }
        .card { background-color: white; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 20px; margin-bottom: 20px; }
        .header-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; color: #1f2937; }
        .form-group { background-color: #eff6ff; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        .form-label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 4px; color: #374151; }
        .input-text { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; }
        .category-header { padding: 10px 15px; font-weight: bold; color: #1f2937; border-bottom: 1px solid #e5e7eb; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background-color: #f3f4f6; }
        .total-row { font-size: 1.125rem; font-weight: bold; border-top: 2px solid #1f2937; }
        .action-button { padding: 12px 24px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .submit-button { background-color: #10b981; color: white; margin-right: 10px; }
        .submit-button:hover { background-color: #059669; }
        .reset-button { background-color: #ef4444; color: white; }
        .reset-button:hover { background-color: #dc2626; }
        .export-button { background-color: #22c55e; color: white; margin-left: 10px; }
        .export-button:hover { background-color: #16a34a; }
        .pdf-button { background-color: #f97316; color: white; margin-left: 10px; }
        .pdf-button:hover { background-color: #ea580c; }
        .excel-button { background-color: #10b981; color: white; margin-left: 10px; }
        .excel-button:hover { background-color: #059669; }
        .delete-order-btn { color: #ef4444; cursor: pointer; background: none; border: none; font-weight: bold; }
        .search-container { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
        .order-item-detail { background-color: #f9fafb; padding: 15px; border-radius: 6px; margin-top: 10px; }
        .input-quantity { width: 60px; text-align: center; } 
        .input-size { width: 80px; text-align: center; text-transform: uppercase; }
        .clear-db-button { background-color: #b91c1c; color: white; }
        .clear-db-button:hover { background-color: #991b1b; }
    </style>
</head>
<body>

<div class="container" id="app">
    <div class="navbar">
        <button id="nav-order" class="nav-button active">üõí Nouvelle Commande</button>
        <button id="nav-database" class="nav-button inactive">üóÑÔ∏è Base de Donn√©es (<span id="orders-count">0</span>)</button>
    </div>

    <div id="order-view" class="card">
        <h2 class="header-title">Bon de Commande</h2>
        
        <div class="form-group">
            <h3>Informations du Triathl√®te</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label for="firstName" class="form-label">Pr√©nom *</label>
                    <input type="text" id="firstName" class="input-text" placeholder="Pr√©nom du triathl√®te">
                </div>
                <div>
                    <label for="lastName" class="form-label">Nom *</label>
                    <input type="text" id="lastName" class="input-text" placeholder="Nom du triathl√®te">
                </div>
            </div>
        </div>

        <div id="catalog-list" style="margin-bottom: 20px;">
            </div>

        <div class="card" style="margin-top: 20px;">
            <div style="display: flex; justify-content: flex-end; align-items: center; gap: 20px; margin-bottom: 10px;">
                <label for="discount" class="form-label" style="margin-right: 10px;">Remise (‚Ç¨):</label>
                <input type="number" id="discount" class="input-text" style="width: 100px; text-align: right;" value="0" min="0">
            </div>
            
            <div style="text-align: right; border-top: 1px solid #e5e7eb; padding-top: 10px;">
                <p style="font-size: 1.1rem;">Sous-total : <span id="subtotal">0</span> ‚Ç¨</p>
                <p class="total-row">TOTAL : <span id="total">0</span> ‚Ç¨</p>
            </div>

            <div style="display: flex; justify-content: center; margin-top: 20px;">
                <button id="reset-current-order-btn" class="action-button reset-button">
                    üóëÔ∏è Effacer la Commande en Cours
                </button>
                <button id="submit-order-btn" class="action-button submit-button" style="margin-left: 20px;">
                    ‚ûï Enregistrer la Commande
                </button>
            </div>
        </div>
    </div>

    <div id="database-view" class="card" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 class="header-title">Base de Donn√©es des Commandes</h2>
            <div style="display: flex; gap: 10px;">
                <button id="export-csv-btn" class="nav-button export-button" style="background-color: #3b82f6;">‚¨áÔ∏è Exporter CSV</button>
                <button id="export-excel-btn" class="nav-button excel-button">üìÑ Exporter Excel</button>
                <button id="export-pdf-btn" class="nav-button pdf-button">üìÑ Exporter PDF</button>
                <button id="clear-database-btn" class="nav-button action-button clear-db-button">
                    ‚ö†Ô∏è Effacer la Base de Donn√©es
                </button>
            </div>
        </div>
        
        <div class="search-container">
            <label for="search-term">üîé Recherche (Nom/Pr√©nom) :</label>
            <input type="text" id="search-term" class="input-text" style="width: 200px;">
        </div>

        <div id="orders-list">
            <p id="no-orders" style="text-align: center; color: #6b7280; display: none;">Aucune commande trouv√©e.</p>
        </div>
    </div>
</div>

<script>
    const CATALOG = {
        'TRI FONCTION HOMMES': [
            { ref: 'NORSAE_V2 Peau S-TRI', price: 74 },
            { ref: 'BORNEO V4', price: 103 },
            { ref: 'BORNEO LD', price: 99 },
            { ref: 'OTILIO Manches courtes. Peau S-Tri - Fermeture s√©parable', price: 116 }
        ],
        'TRI FONCTION FEMMES': [
            { ref: 'FLORIDA_V2 Peau S-Tri - Dos a√©r√©, maille a√©r√©e', price: 72 },
            { ref: 'SIREEN sans manches Bretelles soutien-gorge et Dos nageur', price: 90 },
            { ref: 'FLORIDA Peau S-Tri - Dos entier nageur, maille a√©r√©e', price: 72 },
            { ref: 'ELZA Manches courtes. Peau S-Tri. Dos tr√®s √©chancr√©', price: 93 }
        ],
        'TRI FONCTION JEUNES': [
            { ref: 'NORSAE_V2', price: 50 },
            { ref: 'FLORIDA_V2', price: 50 },
            { ref: 'HENIA Maillot de bain Fille', price: 34 },
            { ref: 'HENI Maillot de bain Gar√ßon', price: 28 }
        ],
        'TRI FONCTION: D√©bardeur et cuissard': [
            { ref: 'TRILAE_V2 D√©bardeur HOMME', price: 42 },
            { ref: 'HALF_V2 Cuissard', price: 51 },
            { ref: 'LIZA Brassi√®re', price: 25 },
            { ref: 'HENI V2 Maillot de bain', price: 29 },
            { ref: 'HENIA Maillot de bain Fille', price: 36 }
        ],
        'TRI FONCTION MIXTE': [
            { ref: 'NORSAE_V2 Peau S-TRI', price: 74 },
            { ref: 'ZACH (avec manches)', price: 83 }
        ],
        'VELO HOMMES': [
            { ref: 'AKSEL mc_V2.1 Maillot MC', price: 49 },
            { ref: 'ROCH ml_V2 Maillot ML', price: 64 },
            { ref: 'EMIL mc_V2 Maillot MC', price: 44 },
            { ref: 'EMIL ml_V2 Maillot ML', price: 47 },
            { ref: 'KYLE_V2.1 Cuissard', price: 58 },
            { ref: 'EDWAR_V2 Collant chaud', price: 68 }
        ],
        'VELO FEMMES': [
            { ref: 'ALICIA mc_V3 Maillot MC', price: 53 },
            { ref: 'ROCH Maillot ML', price: 64 },
            { ref: 'KYLE FEMME V3 Cuissard sans bretelles', price: 54 },
            { ref: 'KYLE FEMME V3 Cuissard avec bretelles', price: 60 },
            { ref: 'EDWAR Cuissard long', price: 70 }
        ],
        'VELO ENFANT/JEUNES': [
            { ref: 'MILIO MC Maillot MC', price: 33 },
            { ref: 'MILIO ML Maillot ML', price: 42 },
            { ref: 'KILIAN Cuissard court', price: 40 },
            { ref: 'EDWIG Cuissard long', price: 56 }
        ],
        'COURSE A PIED': [
            { ref: 'MEDHI short trail', price: 37 },
            { ref: 'TEDDY Collant Poche dos zip', price: 36 },
            { ref: 'BERYL Short plit√©', price: 35 },
            { ref: 'TRACK collant trail', price: 52 },
            { ref: 'VIOLETTE Short running femme', price: 47 },
            { ref: 'KASH', price: 44 },
            { ref: 'PEAK Corsaire Sp√©cial TRAIL', price: 52 },
            { ref: 'LANA MC Tee shirt', price: 28 },
            { ref: 'BERKO MC', price: 31 }
        ],
        'VESTES ET GILETS': [
            { ref: 'NATAN_V2.1 Gilet sans manches Coupe-vent', price: 62 },
            { ref: 'GUSTY_V2 Coupe-vent', price: 54 },
            { ref: 'GUST Coupe-vent', price: 54 },
            { ref: 'PAUL Gilet sans manches amovibles', price: 112 },
            { ref: 'CHESTER V3 Veste Thermique 3poches', price: 98 },
            { ref: 'ADY Capuche adultes', price: 79 },
            { ref: 'HOWEN Sweat adultes', price: 69 },
            { ref: 'ADY Capuche Enfants', price: 67 },
            { ref: 'HOWEN Sweat Enfants', price: 56 }
        ],
        'ACCESSOIRES': [
            { ref: 'Filet de natation', price: 20 },
            { ref: 'Manchettes (si 10 achet√©es)', price: 18 }
        ]
    };

    let state = {
        view: 'order',
        firstName: '',
        lastName: '',
        quantities: {}, // Cl√©: 'category::ref', Valeur: { qty: 0, size: "" }
        discount: 0,
        orders: [],
        searchTerm: ''
    };

    const $ = (id) => document.getElementById(id);

    function loadOrders() {
        const saved = localStorage.getItem('triathlonOrders');
        if (saved) {
            state.orders = JSON.parse(saved);
        }
    }

    function saveOrders(newOrders) {
        localStorage.setItem('triathlonOrders', JSON.stringify(newOrders));
        state.orders = newOrders;
        updateOrderCount();
        renderDatabaseView();
    }

    function updateOrderCount() {
        $('orders-count').textContent = state.orders.length;
    }

    function getQuantityState(key) {
        if (!state.quantities[key]) {
            state.quantities[key] = { qty: 0, size: "" };
        }
        return state.quantities[key];
    }

    // --- Logique de Calcul ---

    function calculateSubtotal() {
        let total = 0;
        Object.entries(state.quantities).forEach(([key, data]) => {
            if (data.qty > 0) {
                const [category, ref] = key.split('::');
                const product = CATALOG[category].find(p => p.ref === ref);
                if (product) {
                    total += product.price * data.qty;
                }
            }
        });
        return total;
    }

    function calculateTotal() {
        const subtotal = calculateSubtotal();
        return Math.max(0, subtotal - state.discount);
    }

    function updateTotal() {
        const subtotal = calculateSubtotal();
        const total = calculateTotal();
        $('subtotal').textContent = subtotal.toFixed(2);
        $('total').textContent = total.toFixed(2);
    }

    // --- Notification ---
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            background-color: ${type === 'success' ? '#10b981' : '#f97316'};
            transition: opacity 0.3s ease-in-out;
            opacity: 1;
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.opacity = 0;
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, 3000);
    }

    // --- Logique d'Interaction ---

    function handleQuantityChange(key, event) {
        const value = parseInt(event.target.value) || 0;
        const data = getQuantityState(key);
        data.qty = Math.max(0, value);
        updateTotal();
    }

    function handleSizeChange(key, event) {
        const value = event.target.value.toUpperCase().trim();
        const data = getQuantityState(key);
        data.size = value;
    }

    function handleDiscountChange(event) {
        const value = parseFloat(event.target.value) || 0;
        state.discount = Math.max(0, value);
        updateTotal();
    }

    function resetCurrentOrder() {
        if (!confirm('√ätes-vous s√ªr de vouloir effacer la commande en cours ?')) {
            return;
        }
        state.firstName = '';
        state.lastName = '';
        state.quantities = {};
        state.discount = 0;
        renderOrderView();
        updateTotal();
        showNotification('Saisie effac√©e.', 'info');
    }

    function handleSubmitOrder() {
        state.firstName = $('firstName').value.trim();
        state.lastName = $('lastName').value.trim();

        if (!state.firstName || !state.lastName) {
            alert('Veuillez renseigner le nom et pr√©nom du triathl√®te');
            return;
        }

        const items = [];
        let hasError = false;

        Object.entries(state.quantities).forEach(([key, data]) => {
            if (data.qty > 0) {
                const [category, ref] = key.split('::');
                const product = CATALOG[category].find(p => p.ref === ref);
                
                if (product) {
                    // Validation de la taille : Si la quantit√© > 0, la taille doit √™tre renseign√©e.
                    if (!data.size) {
                        alert(`Veuillez saisir la taille pour le produit : "${product.ref}" (Cat√©gorie: "${category}")`);
                        hasError = true;
                        return;
                    }

                    items.push({
                        category,
                        ref: product.ref,
                        quantity: data.qty,
                        size: data.size, 
                        unitPrice: product.price,
                        totalPrice: product.price * data.qty
                    });
                }
            }
        });

        if (hasError) return;
        
        if (items.length === 0) {
            alert('Veuillez s√©lectionner au moins un produit');
            return;
        }

        const order = {
            id: `order-${Date.now()}`,
            date: new Date().toISOString(),
            firstName: state.firstName,
            lastName: state.lastName,
            items,
